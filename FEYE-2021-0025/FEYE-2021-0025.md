# FEYE-2021-0025
## Description
On a recent client engagement, Mandiant discovered a weakness in the Microsoft Windows operating system which allows an attacker to export certificates from the Windows certificate store in an unauthorized fashion.

## Impact
Medium - An attacker can abuse this vulnerability to export certificates in an unauthorized fashion, possibly allowing the attacker to impersonate the victim on services using certificate authentication. Note that the attacker can only impersonate principals he/she already has access to (i.e. no lateral movement is taking place).

## Exploitability
Medium - An attacker needs access to the target user or system to request a new certificate. The attacker must be able to request the certificate at exploitation time (previously stored certificates are not vulnerable). Additionally, the target environment must be using certificates as a means of authentication.

## Technical Details
When configuring Certificate Templates in Active Directory Certificate Services (AD CS), the certificate administrator has the opportunity to mark a Certificate Template as either exportable or non-exportable ("Allow private key to be exported" setting). 
Mandiant observed that, when requesting a new certificate, the requester can override the exportable setting on the template, resulting in a certificate that can be exported (regardless of the setting configured by the certificate administrator on the template). Mandiant observed this behaviour on an up-to-date Windows Server 2019 AD CS server and up-to-date Windows 10 client (note that other versions of Windows might also be affected). 

To replicate this behaviour, create a duplicate of the default ‘User’ certificate template on an AD CS server, and uncheck the exportable flag. 
When the requester selects the certificate template, he/she has the option to add additional properties, corresponding to the settings of the certificate template. To exploit the vulnerability, the ‘make private key exportable’ flag must be checked in the request. After submitting the request, the certificate is issued successfully, despite the incompatible private key export setting between the certificate request and the certificate template. Finally, the certificate and corresponding private key can be exported from the victim’s certificate store, regardless of the setting configured by the certificate administrator on the certificate template.
 
Mandiant observed that when the requester specifies incompatible values on other certificate settings, such as certificate properties (Key Usage, Subject, et cetera), the request either (a) fails due to incompatible settings, or (b) the settings from the certificate template take precedence of the settings defined in the certificate request. 

## Scope

Mandiant observed this behaviour for both User & Computer certificates, regardless of base certificate template, certificate compatibility settings or certificate extension settings. Mandiant also observed this behaviour regardless of cryptographic provider (both the legacy `CAPI` providers and the newer `CNG` providers are vulnerable - hardware-backed providers are not vulnerable). 

`CAPI` certificates are known to be vulnerable to unauthorized exporting by patching the memory of the `CryptoAPI` module in the calling process (public tutorials and tools are available [1]). `CNG` certificates do not suffer from this weakness, as the certificate export flows through the `LSASS` process.

## Mitigation
Mandiant recommends to use TPM-backed private keys for sensitive certificates, and to reconfigure certificate templates to only allow Key Storage Providers (KSPs) backed by TPM, physical smart cards or other Hardware Security Modules (HSM). Microsoft provides guidance [3] on setting up certificate templates in such a way.

## Discovery Credits
Thibault Van Geluwe de Berlaere, Mandiant

## Disclosure Timeline

* 16/07/2021: Vulnerability submitted to MSRC
* 16/07/2021: MSRC opens a case for the submission
* 10/08/2021: MSRC responded stating that the behavior is "by design" and the AD CS server has no means of enforcing key protection on the requesting system
* 10/08/2021: Responded to MSRC that the vulnerability does not lie within the AD CS server, but the Windows OS on the requesting system (Windows is incorrectly saving the export settings)
* 10/08/2021: MSRC responded stating that the feedback will be passed on to the engineers
* 24/08/2021: Asked MSRC for an update on the case
* 25/08/2021: MSRC responds that the feedback did not change the view of the engineers, referencing a blog post [2]
* 25/08/2021: Responded to MSRC stating that the conclusion of the blog post ("_Windows tools that do certificate enrollment such as Certificate Manager snapin, certreq.exe, and our APIs will honor it [certificate template setting(s)]_") directly conflicts with the behavior observed in the built-in Windows Certificate Manager
* 25/08/2021: MRSC responds that the feedback will be passed along to the engineers
* 01/09/2021: Asked MSRC for an update on the case
* 01/09/2021: MSRC responded that no update was available yet
* 08/09/2021: Asked MSRC for an update on the case
* 09/09/2021: MSRC responded that they classified the behavior as a _UI bug_ and "_may consider it as a next version candidate_". However, the submission does not meet the Windows Security Bug Bar and therefore the case will be closed.
* 14/09/2021: Advisory published

## References 

1. [Exporting certificates saved with CAPI providers](https://gist.github.com/derrickorama/7b08298b657048660293)
2. [What is a strong key protection in Windows?](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/what-is-a-strong-key-protection-in-windows/ba-p/1128527)
3. [Setting up TPM protected certificates using a Microsoft Certificate Authority](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/setting-up-tpm-protected-certificates-using-a-microsoft/ba-p/1129055)
